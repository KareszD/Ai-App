<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Image Upload UI</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f8f9fa;
        position: relative; /* To position the status indicator and toggle button */
      }
      h1 {
        color: #343a40;
      }
      .container {
        text-align: center;
        width: 100%;
        max-width: 600px; /* Adjusted for better layout */
      }
      .dark-mode {
        background-color: #121212;
        color: #ffffff;
      }
      .dark-mode input, .dark-mode button {
        color: #000;
      }
      #toggleDarkMode {
        position: absolute;
        top: 20px;
        right: 60px; /* Adjusted to make space for the status indicator */
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #ffffff; /* Adjust color for visibility in dark mode */
      }
      #apiStatus {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: red; /* Default to red (API down) */
        border: 2px solid #fff;
      }
      .progress-container {
        width: 100%;
        max-width: 500px;
        margin-top: 20px;
      }
      /* Styles for result display */
      .result-container {
        margin-top: 30px;
        width: 100%;
        max-width: 600px;
        display: none; /* Hidden by default */
      }
      .result-item {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        background-color: #ffffff;
        padding: 10px;
        border-radius: 5px;
      }
      .dark-mode .result-item {
        background-color: #1e1e1e;
      }
      .result-item img {
        max-width: 150px;
        max-height: 150px;
        margin-right: 20px;
        border-radius: 5px;
      }
      .result-text {
        flex: 1;
        text-align: left;
      }
      /* Responsive adjustments */
      @media (max-width: 576px) {
        .result-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .result-item img {
          margin-bottom: 10px;
          margin-right: 0;
        }
        #toggleDarkMode {
          right: 40px;
        }
      }
    </style>
  </head>
  <body class="dark-mode">
    <!-- Dark Mode Toggle Button -->
    <button id="toggleDarkMode" class="btn">ðŸŒ™</button>
    
    <!-- API Status Indicator -->
    <div id="apiStatus" title="API Status"></div>

    <div class="container">
      <h1 id="message">Hello World!</h1>
      <div class="mb-3">
        <input type="file" id="imageInput" class="form-control" accept="image/*" multiple>
      </div>
      <button id="sendImage" class="btn btn-success mb-3">Send Images to API</button>
      <div class="progress-container">
        <div class="progress">
          <div id="progressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <p id="timerEstimate" class="mt-2">Estimated time remaining: 0 minutes</p>
      </div>
    </div>

    <!-- Result Display Section -->
    <div class="result-container" id="resultContainer">
      <h2>Prediction Results</h2>
      <!-- Individual results will be appended here -->
    </div>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Your JavaScript -->
    <script>
      // Get references to DOM elements
const imageInput = document.getElementById('imageInput');
const sendImageButton = document.getElementById('sendImage');
const message = document.getElementById('message');
const progressBar = document.getElementById('progressBar');
const timerEstimate = document.getElementById('timerEstimate');
const resultContainer = document.getElementById('resultContainer');
const toggleDarkModeButton = document.getElementById('toggleDarkMode');
const apiStatusIndicator = document.getElementById('apiStatus');

let selectedImageFiles = [];
let completedFiles = 0;

// Handle image selection
imageInput.addEventListener('change', (event) => {
    selectedImageFiles = Array.from(event.target.files);
    if (selectedImageFiles.length > 0) {
        message.textContent = `Selected ${selectedImageFiles.length} file(s)`;
    } else {
        message.textContent = 'Please select images to upload.';
    }
});

// Handle send image button click
sendImageButton.addEventListener('click', () => {
    if (selectedImageFiles.length > 0) {
        let totalFiles = selectedImageFiles.length;
        completedFiles = 0;
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        progressBar.textContent = '0%';
        timerEstimate.textContent = `Estimated time remaining: ${totalFiles * 20} seconds`;
        resultContainer.innerHTML = '<h2>Prediction Results</h2>'; // Reset results
        resultContainer.style.display = 'none'; // Hide results initially

        selectedImageFiles.forEach((file, index) => {
            uploadImage(file, index, totalFiles);
        });
    } else {
        message.textContent = 'Please select images first.';
    }
});

// Function to upload a single image
function uploadImage(file, index, totalFiles) {
    const formData = new FormData();
    formData.append('image', file);

    // Replace with your actual API endpoint
    const apiUrl = 'http://localhost:5000/upload';

    fetch(apiUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Image uploaded successfully') {
            const taskId = data.task_id;
            // Start polling for progress and results
            pollProgress(taskId, file.name, totalFiles);
        } else {
            message.textContent = `Error uploading image: ${data.error}`;
        }
    })
    .catch(error => {
        message.textContent = 'Error uploading image.';
        console.error('Upload Error:', error);
    });
}

// Function to poll progress for a task
function pollProgress(taskId, filename, totalFiles) {
    const intervalId = setInterval(() => {
        fetch(`http://localhost:5000/progress?task_id=${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                clearInterval(intervalId);
                message.textContent = `Progress error: ${data.error}`;
                return;
            }

            const progress = data.progress;
            updateOverallProgress();

            if (progress >= 100) {
                clearInterval(intervalId);
                fetchResult(taskId, filename);
            }
        })
        .catch(error => {
            clearInterval(intervalId);
            message.textContent = 'Error fetching progress.';
            console.error('Progress Polling Error:', error);
        });
    }, 1000); // Poll every second
}

// Function to fetch result after completion
function fetchResult(taskId, filename) {
    fetch(`http://localhost:5000/result?task_id=${taskId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            message.textContent = `Result error: ${data.error}`;
            return;
        }

        // Display the result
        displayResult(taskId, filename, data.result);
    })
    .catch(error => {
        message.textContent = 'Error fetching result.';
        console.error('Result Fetch Error:', error);
    });
}

// Function to display the result in the UI
function displayResult(taskId, filename, resultMessage) {
    // Construct the URL to fetch the result image
    const resultImagePath = `http://localhost:5000/results/${taskId}_${filename}_result.png`;

    // Create a container for each result
    const individualResultContainer = document.createElement('div');
    individualResultContainer.classList.add('result-item');

    // Create and set the result image
    const img = document.createElement('img');
    img.src = resultImagePath;
    img.alt = `Result for ${filename}`;
    img.onerror = () => {
        img.src = 'path_to_placeholder_image.png'; // Replace with a placeholder image path
    };

    // Create and set the result text
    const text = document.createElement('div');
    text.classList.add('result-text');
    text.textContent = resultMessage;

    // Append elements to the individual result container
    individualResultContainer.appendChild(img);
    individualResultContainer.appendChild(text);

    // Append the individual result container to the main result container
    resultContainer.appendChild(individualResultContainer);

    // Make sure the result container is visible
    resultContainer.style.display = 'block';
}

// Function to update the overall progress bar
function updateOverallProgress() {
    completedFiles++;
    const progressPercentage = (completedFiles / selectedImageFiles.length) * 100;
    progressBar.style.width = `${progressPercentage}%`;
    progressBar.setAttribute('aria-valuenow', progressPercentage);
    progressBar.textContent = `${Math.round(progressPercentage)}%`;
    timerEstimate.textContent = `Estimated time remaining: ${(selectedImageFiles.length - completedFiles) * 20} seconds`;

    // If all files are processed, reset selection
    if (completedFiles === selectedImageFiles.length) {
        selectedImageFiles = [];
        imageInput.value = ''; // Reset the file input
    }
}

// Handle Dark Mode Toggle
toggleDarkModeButton.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    // Toggle icon
    if (document.body.classList.contains('dark-mode')) {
        toggleDarkModeButton.textContent = 'ðŸŒ™';
    } else {
        toggleDarkModeButton.textContent = 'â˜€ï¸';
    }
});

// Function to check API status periodically
function checkApiStatus() {
    fetch('http://localhost:5000/status')
    .then(response => {
        if (response.ok) {
            apiStatusIndicator.style.backgroundColor = 'green';
        } else {
            apiStatusIndicator.style.backgroundColor = 'red';
        }
    })
    .catch(error => {
        apiStatusIndicator.style.backgroundColor = 'red';
        console.error('API Status Check Error:', error);
    });
}

// Initial API status check
checkApiStatus();

// Periodically check API status every 30 seconds
setInterval(checkApiStatus, 1000);
    </script>
    <!-- Bootstrap JS Bundle (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
