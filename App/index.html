<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Image Upload UI</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f8f9fa;
        position: relative; /* To position the status indicator and toggle button */
      }
      h1 {
        color: #343a40;
      }
      .container {
        text-align: center;
      }
      .dark-mode {
        background-color: #121212;
        color: #ffffff;
      }
      .dark-mode input, .dark-mode button {
        color: #000;
      }
      #toggleDarkMode {
        position: absolute;
        top: 20px;
        right: 60px; /* Adjusted to make space for the status indicator */
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }
      #apiStatus {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: red; /* Default to red (API down) */
        border: 2px solid #fff;
      }
      .progress-container {
        width: 100%;
        max-width: 500px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body class="dark-mode">
    <!-- Dark Mode Toggle Button -->
    <button id="toggleDarkMode" class="btn">‚òÄÔ∏è</button>
    
    <!-- API Status Indicator -->
    <div id="apiStatus" title="API Status"></div>

    <div class="container">
      <h1 id="message">Hello World!</h1>
      <div class="mb-3">
        <input type="file" id="imageInput" class="form-control" accept="image/*" multiple>
      </div>
      <button id="sendImage" class="btn btn-success mb-3">Send Images to API</button>
      <div class="progress-container">
        <div class="progress">
          <div id="progressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <p id="timerEstimate" class="mt-2">Estimated time remaining: 0 minutes</p>
      </div>
    </div>

    <script>
      const message = document.getElementById('message');
      const imageInput = document.getElementById('imageInput');
      const sendImageButton = document.getElementById('sendImage');
      const toggleDarkModeButton = document.getElementById('toggleDarkMode');
      const progressBar = document.getElementById('progressBar');
      const timerEstimate = document.getElementById('timerEstimate');
      const apiStatusIndicator = document.getElementById('apiStatus');
      const { spawn } = require('child_process');
      //const pyProg = spawn('python',"../Py/api.py " );
      let selectedImageFiles = [];

      // Function to check API status
      function checkApiStatus() {
        // Example API Status URL - replace with your actual status endpoint
        const statusUrl = 'http://localhost:5000/status';

        fetch(statusUrl, { method: 'GET' })
          .then(response => {
            if (response.ok) {
              // API is running
              apiStatusIndicator.style.backgroundColor = 'green';
              apiStatusIndicator.title = 'API is running';
            } else {
              // API responded but with an error status
              apiStatusIndicator.style.backgroundColor = 'red';
              apiStatusIndicator.title = 'API error';
            }
          })
          .catch(error => {
            // Unable to reach API
            apiStatusIndicator.style.backgroundColor = 'red';
            apiStatusIndicator.title = 'API is down';
            console.error('API Status Check Error:', error);
          });
      }

      // Initial API status check
      checkApiStatus();

      // Check API status every 10 seconds
      setInterval(checkApiStatus, 10000);

      imageInput.addEventListener('change', (event) => {
        selectedImageFiles = Array.from(event.target.files);
        if (selectedImageFiles.length > 0) {
          message.textContent = `Selected ${selectedImageFiles.length} file(s)`;
        } else {
          message.textContent = 'Hello World!';
        }
      });

      sendImageButton.addEventListener('click', () => {
        if (selectedImageFiles.length > 0) {
          let totalFiles = selectedImageFiles.length;
          let completedFiles = 0;
          progressBar.style.width = '0%';
          progressBar.setAttribute('aria-valuenow', 0);
          timerEstimate.textContent = `Estimated time remaining: ${totalFiles * 20} minutes`;

          selectedImageFiles.forEach((file, index) => {
            const formData = new FormData();
            formData.append('image', file);

            // Example API URL - replace with your actual API endpoint
            const apiUrl = 'http://localhost:5000/upload';

            fetch(apiUrl, {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.message === 'Image uploaded successfully') {
                completedFiles++;
                updateProgress(totalFiles);
              } else {
                message.textContent = `Error uploading image: ${data.message}`;
              }
            })
            .catch(error => {
              message.textContent = 'Error uploading image.';
              console.error('Upload Error:', error);
            });
          });
        } else {
          message.textContent = 'Please select images first.';
        }
      });

      function updateProgress(totalFiles) {
        const intervalId = setInterval(() => {
          // Example API Progress URL - replace with your actual progress endpoint
          const progressUrl = 'http://localhost:5000/progress';

          fetch(progressUrl)
            .then(response => response.json())
            .then(data => {
              let progress = data.progress; // Assume API returns { "progress": 50 }
              progressBar.style.width = `${progress}%`;
              progressBar.setAttribute('aria-valuenow', progress);
              timerEstimate.textContent = `Estimated time remaining: ${Math.max(0, Math.ceil((totalFiles - (progress / 100 * totalFiles)) * 20))} minutes`;
              console.log(`Progress: ${progress}%`);

              if (progress >= 100) {
                clearInterval(intervalId);
                message.textContent = 'All images processed successfully!';
              }
            })
            .catch(error => {
              console.error('Error fetching progress:', error);
            });
        }, 2000);
      }

      toggleDarkModeButton.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          toggleDarkModeButton.textContent = 'üåô'; // Moon icon
        } else {
          toggleDarkModeButton.textContent = '‚òÄÔ∏è'; // Sun icon
        }
      });
    </script>
    <!-- Bootstrap JS Bundle (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
